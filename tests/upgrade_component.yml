- name: Check
  shell:
    cmd: "cd /opt/{{ package }}&&./upgrade_from_file_list filelist.yaml check&&cd -"
    executable: /bin/sh
  register: check_result
  when: upgrade_type == 'inc'
  ignore_errors: no

- name: Check and decide to continue
  fail:
    msg: "Version does not meet requirements, exiting."
  when: upgrade_type == 'inc' and check_result.rc != 0

- name: Stop services
  systemd:
    name: "{{ item }}"
    state: stopped
  with_items: "{{ services }}"

- name: Find the PID of the process to terminate
  shell:
    cmd: "pgrep -f 'scripts/check.sh'"
    executable: /bin/sh
  register: pid_result
  ignore_errors: yes

- name: Terminate the found process
  shell:
    cmd: "kill -9 {{ item }}"
    executable: /bin/sh
  loop: "{{ pid_result.stdout_lines }}"
  when: pid_result.stdout_lines | length > 0
  ignore_errors: yes
  
- name: Stop waf services
  shell: service {{ item }} stop
  register: stop_waf_result
  ignore_errors: yes
  with_items: "{{ waf_services }}"

- name: Upgrade incremental
  shell:
    cmd: "cd /opt/{{ package }}&&./upgrade_from_file_list filelist.yaml upgrade&&cd -"
    executable: /bin/sh
  register: upgrade_result
  when: upgrade_type == 'inc'
  ignore_errors: yes

- name: Upgrade full
  shell:
    cmd: "cd /opt/WAF &&./waf-reinstall update node &&cd -"
    executable: /bin/sh
  register: upgrade_result
  when: upgrade_type == 'full'
  ignore_errors: yes

- name: Custom install
  shell:
    cmd: "cd /opt/{{ package }}&&./custom_install.sh&&cd -"
    executable: /bin/sh
  ignore_errors: yes

- name: Start waf services
  shell: service {{ item }} start
  register: start_waf_result
  with_items: "{{ waf_services }}"
  ignore_errors: yes

- name: curl check
  shell:
    cmd: 'curl http://127.0.0.1:57980 -H "Host: wafdemo.dbappcloud.com"'
    executable: /bin/sh
  ignore_errors: yes

- name: Start services
  systemd:
    name: "{{ item }}"
    state: started
  with_items: "{{ services }}"

