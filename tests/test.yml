---
# 文件名：upgrade_servers.yml

- name: Server Batch Upgrade
  hosts: tag1
  serial: 2
  gather_facts: no
  vars:
    old_version: v1
    new_version: v2
    upgrade_package: yaml_data_{{ new_version }}
    upgrade_sequence: 
      - waf1
      - waf2
    process_name: check.sh

  tasks:
#  - name: Transfer upgrade package
#    copy:
#      src: "{{ upgrade_package }}.tar.gz"
#      dest: /opt/{{ upgrade_package }}.tar.gz
#      owner: root
#      group: root
#      mode: 0755
#
#  - name: Unarchive the upgrade package
#    unarchive:
#      src: /opt/{{ upgrade_package }}.tar.gz
#      dest: /opt/
#      remote_src: yes #远程文件路径
#      creates: /opt/{{ upgrade_package }} #当指定目录不存在时，ansible才执行解压操作
  - name: Find the PID of the process to terminate
    shell:
      cmd: "pgrep -f 'scripts/check.sh'"
      executable: /bin/sh
    register: pid_result #将命令结果注册为变量pid_result，以便后续步骤使用。
    ignore_errors: yes #忽略错误，以防进程不存在或权限问题。

  - name: Terminate the found process
    shell:
      cmd: "kill -9 {{ item }}"
      executable: /bin/sh
    loop: "{{ pid_result.stdout_lines }}"
    when: pid_result.stdout_lines | length > 0
    ignore_errors: yes