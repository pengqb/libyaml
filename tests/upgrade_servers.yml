---
# 文件名：upgrade_servers.yml

- name: Check project version
  hosts: all
  gather_facts: no

  tasks:
    - name: Check project version
      command: awk 'END{print}' /waf/doc/VERSION
      register: version_result
      changed_when: false
      ignore_errors: true

    - name: Compare version and decide to continue
      fail:
        msg: "Version does not meet requirements, exiting."
      when: version_result.stdout != old_version

- name: Server Batch Upgrade
  hosts: all
  serial: 5
  gather_facts: no
  tasks:
  - name: Transfer upgrade package
    copy:
      src: "{{ package }}_{{ upgrade_type }}.tgz"
      dest: /opt/{{ package }}_{{ upgrade_type }}.tgz
      owner: root
      group: root
      mode: 0755
  - name: Unarchive the upgrade package
    unarchive:
      src: /opt/{{ package }}_{{ upgrade_type }}.tgz
      dest: /opt/
      remote_src: yes #远程文件路径
      creates: /opt/{{ package }}_{{ upgrade_type }} #当指定目录不存在时，ansible才执行解压操作

- name: Tasks Execution on waf1
  hosts: waf1
  gather_facts: no
  vars:
    services:
      - crond
    waf_services:
      - waf-sync
      - waf
  tasks:
    - include_tasks: upgrade_component.yml

- name: Tasks Execution on waf2
  hosts: waf2
  gather_facts: no
  vars:
    services:
      - crond
    waf_services:
      - waf-sync
      - waf
  tasks:
    - include_tasks: upgrade_component.yml