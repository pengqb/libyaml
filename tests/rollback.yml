---
# 文件名：upgrade_servers.yml

- name: Server Batch Upgrade
  hosts: rollback_servers
  gather_facts: no
  vars:
    services:
      - crond
    waf_services:
      - waf-sync
      - waf

  tasks:
    - name: Stop services
      systemd:
        name: "{{ item }}"
        state: stopped
      with_items: "{{ services }}"

    - name: Find the PID of the process to terminate
      shell:
        cmd: "pgrep -f 'scripts/check.sh'"
        executable: /bin/sh
      register: pid_result
      ignore_errors: yes

    - name: Terminate the found process
      shell:
        cmd: "kill -9 {{ item }}"
        executable: /bin/sh
      loop: "{{ pid_result.stdout_lines }}"
      when: pid_result.stdout_lines | length > 0
      ignore_errors: yes

    - name: Stop waf services
      shell: service {{ item }} stop
      register: stop_waf_result
      ignore_errors: yes
      with_items: "{{ waf_services }}"

    - name: Roll back
      shell:
        cmd: "cd /opt/{{ package }}_inc&&./upgrade_from_file_list filelist.yaml rollback&&cd -"
        executable: /bin/sh
      register: upgrade_result

    - name: Custom roll back
      shell:
        cmd: "cd /opt/{{ package }}_inc&&./custom_rollback.sh&&cd -"
        executable: /bin/sh

    - name: Start waf services
      shell: service {{ item }} start
      register: start_waf_result
      async: 300
      poll: 20
      with_items: "{{ waf_services }}"
      ignore_errors: yes

    - name: Curl check
      shell:
        cmd: 'curl http://127.0.0.1:57980 -H "Host: wafdemo.dbappcloud.com" -I'
        executable: /bin/sh
        warn: false
      register: curl_result
      ignore_errors: yes

    - name: Curl result
      debug:
        msg: "{{ curl_result.stdout }}"

    - name: Start services
      systemd:
        name: "{{ item }}"
        state: started
      with_items: "{{ services }}"